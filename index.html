<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="let&apos;s get started">
<meta property="og:type" content="website">
<meta property="og:title" content="DrunkPiano的Android日常">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="DrunkPiano的Android日常">
<meta property="og:description" content="let&apos;s get started">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DrunkPiano的Android日常">
<meta name="twitter:description" content="let&apos;s get started">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> DrunkPiano的Android日常 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">DrunkPiano的Android日常</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Let's get started from Android ~</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/09/EP15-android-architecture-1/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DrunkPiano">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DrunkPiano的Android日常">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DrunkPiano的Android日常" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/09/EP15-android-architecture-1/" itemprop="url">
                  EP15-android-architecture(1)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-09T20:48:22+08:00">
                2016-12-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/09/EP15-android-architecture-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/09/EP15-android-architecture-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>发现了一个Google samples提供的关于开发模式的android-architecture仓库：<br><a href="https://github.com/googlesamples/android-architecture。" target="_blank" rel="external">https://github.com/googlesamples/android-architecture。</a><br>他说：    </p>
<blockquote>
<p>The Android framework offers a lot of flexibility when it comes to defining how to organize and architect an Android app. This freedom, whilst very valuable, can also result in apps with large classes, inconsistent naming and architectures (or lack of) that can make testing, maintaining and extending difficult.<br>在涉及到如何组织和搭建App的时候，Android Framework提供了很多弹性的机制。这种自由很有价值，但也会造成app体积臃肿，前后命名冲突，和架构在测试、维持和扩展上的困难。    </p>
</blockquote>
<p>所以他们提供了一些简单的、直接的例子来展示一些架构。但是所有的例子都是基于MVP的，包括里面的DataBinding也是基于MVP。所以，对于Android来说，MVP是很流行，也很合适。下面这个图是各种MVP sample的对比：<br><img src="/uploads/android-architecture.png" alt="image"></p>
<p>**dex方法数仅仅是对例子中的app来说的，不会线性增长。比如大型工程应该会受益于使用Data Binding的补偿修正(compensating the overhead)。    </p>
<p>**LOC代表Lines of code，Java代码的行数。    </p>
<p>在不对这些种类的MVP进行了解的前提下，仅仅从这张图看来，todo-mvp，todo-mvp-clean和todo-mvp-loaders大概是最适合使用的。通过对DataBinding的了解，我感觉Complexity / Learning cost也是很重要的。接下来会继续了解一下他们。    </p>
<p>-DEC 9</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/08/EP14-DataBinding-2/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DrunkPiano">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DrunkPiano的Android日常">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DrunkPiano的Android日常" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/08/EP14-DataBinding-2/" itemprop="url">
                  EP14-DataBinding(2)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-08T22:58:11+08:00">
                2016-12-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/08/EP14-DataBinding-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/08/EP14-DataBinding-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="事件绑定"><a href="#事件绑定" class="headerlink" title="事件绑定"></a>事件绑定</h3><h4 id="Method-References"><a href="#Method-References" class="headerlink" title="Method References"></a>Method References</h4><p>事件可以被直接绑定到handler，类似于Activity中onClick可以被指派给一个方法。相比View#onClick的一个优势是，这个表达式会在编译时被处理，所以如果方法不存在或者签名不对，或编译错误。    </p>
<p>Method References和Listener Bindings的一个主要区别是，前者的listener的真正实现是在data被绑定的时候，而不是事件被触发的时候。如果想在事件发生时评估表达式，请用listener binding。    </p>
<p>分配event给handler，使用一个正常的binding表达式，它的值就是被调用的方法名。例如,if your data object has two methods:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandlers</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClickFriend</span><span class="params">(View view)</span> </span>&#123; ... &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>binding表达式可以分配click listener到一个View：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line">&lt;layout xmlns:android="http://schemas.android.com/apk/res/android"&gt;</div><div class="line">   &lt;data&gt;</div><div class="line">       &lt;variable name="handlers" type="com.example.Handlers"/&gt;</div><div class="line">       &lt;variable name="user" type="com.example.User"/&gt;</div><div class="line">   &lt;/data&gt;</div><div class="line">   &lt;LinearLayout</div><div class="line">       android:orientation="vertical"</div><div class="line">       android:layout_width="match_parent"</div><div class="line">       android:layout_height="match_parent"&gt;</div><div class="line">       &lt;TextView android:layout_width="wrap_content"</div><div class="line">           android:layout_height="wrap_content"</div><div class="line">           android:text="@&#123;user.firstName&#125;"</div><div class="line">           android:onClick="@&#123;handlers::onClickFriend&#125;"/&gt;</div><div class="line">   &lt;/LinearLayout&gt;</div><div class="line">&lt;/layout&gt;</div></pre></td></tr></table></figure>
<p>注意，表达式(expression)中的方法的签名(signature)必须和Listener Object中的方法的签名完全一致。</p>
<h4 id="Listener-Bindings"><a href="#Listener-Bindings" class="headerlink" title="Listener Bindings"></a>Listener Bindings</h4><p>Listener Bindings使用更为灵活，跟Method References类似，但可以让你运行随意的data binding表达式。这里不介绍了。     </p>
<h3 id="Layout的细节"><a href="#Layout的细节" class="headerlink" title="Layout的细节"></a>Layout的细节</h3><h4 id="1-Imports"><a href="#1-Imports" class="headerlink" title="1. Imports"></a>1. Imports</h4><p>在data节点中这样添加引用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"android.view.View"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这样，你可以在binding表达式中使用View了：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">   <span class="attr">android:text</span>=<span class="string">"@&#123;user.lastName&#125;"</span></div><div class="line">   <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">   <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">   <span class="attr">android:visibility</span>=<span class="string">"@&#123;user.isAdult ? View.VISIBLE : View.GONE&#125;"</span>/&gt;</div></pre></td></tr></table></figure>
<p>类名冲突的时候，可以取别名(alias):</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"android.view.View"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"com.example.real.estate.View"</span></span></div><div class="line">        <span class="attr">alias</span>=<span class="string">"Vista"</span>/&gt;</div></pre></td></tr></table></figure>
<p>variables和表达式的type references中都可以用引用的type：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"com.example.User"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"java.util.List"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"User"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"userList"</span> <span class="attr">type</span>=<span class="string">"List&lt;User&gt;"</span>/&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">data</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在表达式中引用静态field和方法的时候也能使用引用的type：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;data&gt;</div><div class="line">    &lt;import type=&quot;com.example.MyStringUtils&quot;/&gt;</div><div class="line">    &lt;variable name=&quot;user&quot; type=&quot;com.example.User&quot;/&gt;</div><div class="line">&lt;/data&gt;</div><div class="line">…</div><div class="line">&lt;TextView</div><div class="line">   android:text=&quot;@&#123;MyStringUtils.capitalize(user.lastName)&#125;&quot;</div><div class="line">   android:layout_width=&quot;wrap_content&quot;</div><div class="line">   android:layout_height=&quot;wrap_content&quot;/&gt;</div></pre></td></tr></table></figure>
<p>跟Java中一样，java.lang.*这种类会被自动导入。</p>
<h4 id="2-Variables"><a href="#2-Variables" class="headerlink" title="2. Variables"></a>2. Variables</h4><p>这里涉及到实现Observable或observable collection的问题，暂时调过。    </p>
<h4 id="3-自定义Binding类名称"><a href="#3-自定义Binding类名称" class="headerlink" title="3. 自定义Binding类名称"></a>3. 自定义Binding类名称</h4><p>默认情况下会根据layout文件生成一个Binding类，放置在包名根目录下。<br>也可以通过在data节点加入路径和Binding类名来自定义：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">data</span> <span class="attr">class</span>=<span class="string">"com.example.ContactItem"</span>&gt;</span></div><div class="line">    ...</div><div class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="4-Includes"><a href="#4-Includes" class="headerlink" title="4. Includes"></a>4. Includes</h4><p>Variables may be passed into an included layout’s binding from the containing layout by using the application namespace and the variable name in an attribute:<br>通过使用application namespace和variable name，可以把变量传递给一个被包含的layout里面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;layout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">        xmlns:bind=&quot;http://schemas.android.com/apk/res-auto&quot;&gt;</div><div class="line">   &lt;data&gt;</div><div class="line">       &lt;variable name=&quot;user&quot; type=&quot;com.example.User&quot;/&gt;</div><div class="line">   &lt;/data&gt;</div><div class="line">   &lt;LinearLayout</div><div class="line">       android:orientation=&quot;vertical&quot;</div><div class="line">       android:layout_width=&quot;match_parent&quot;</div><div class="line">       android:layout_height=&quot;match_parent&quot;&gt;</div><div class="line">       &lt;include layout=&quot;@layout/name&quot;</div><div class="line">           bind:user=&quot;@&#123;user&#125;&quot;/&gt;</div><div class="line">       &lt;include layout=&quot;@layout/contact&quot;</div><div class="line">           bind:user=&quot;@&#123;user&#125;&quot;/&gt;</div><div class="line">   &lt;/LinearLayout&gt;</div><div class="line">&lt;/layout&gt;</div></pre></td></tr></table></figure>
<p>这里，name.xml和contact.xml里面必须要有user variable。<br>Data Binding不支持include merge 元素的直接child，<strong>下面这样是不行的</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;layout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">        xmlns:bind=&quot;http://schemas.android.com/apk/res-auto&quot;&gt;</div><div class="line">   &lt;data&gt;</div><div class="line">       &lt;variable name=&quot;user&quot; type=&quot;com.example.User&quot;/&gt;</div><div class="line">   &lt;/data&gt;</div><div class="line">   &lt;merge&gt;</div><div class="line">       &lt;include layout=&quot;@layout/name&quot;</div><div class="line">           bind:user=&quot;@&#123;user&#125;&quot;/&gt;</div><div class="line">       &lt;include layout=&quot;@layout/contact&quot;</div><div class="line">           bind:user=&quot;@&#123;user&#125;&quot;/&gt;</div><div class="line">   &lt;/merge&gt;</div><div class="line">&lt;/layout&gt;</div></pre></td></tr></table></figure>
<h4 id="5-表达式"><a href="#5-表达式" class="headerlink" title="5. 表达式"></a>5. 表达式</h4><h5 id="通用特性："><a href="#通用特性：" class="headerlink" title="通用特性："></a>通用特性：</h5><ul>
<li>Mathematical + - / * %</li>
<li>String concatenation +</li>
<li>Logical &amp;&amp; ||</li>
<li>Binary &amp; | ^</li>
<li>Unary + - ! ~</li>
<li>Shift &gt;&gt; &gt;&gt;&gt; &lt;&lt;(移位 )</li>
<li>Comparison == &gt; &lt; &gt;= &lt;=</li>
<li>instanceof</li>
<li>Grouping ()</li>
<li>Literals - character, String, numeric, null</li>
<li>Cast</li>
<li>Method calls(方法调用)</li>
<li>Field access</li>
<li>Array access []</li>
<li>Ternary operator(三元运算) ?:</li>
</ul>
<p>e.g.<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">android:text="@&#123;String.valueOf(index + 1)&#125;"</div><div class="line">android:visibility="@&#123;age <span class="tag">&lt; <span class="attr">13</span> ? <span class="attr">View.GONE</span> <span class="attr">:</span> <span class="attr">View.VISIBLE</span>&#125;"</span></div><div class="line"><span class="attr">android:transitionName</span>=<span class="string">'@&#123;"image_" + id&#125;'</span></div></pre></td></tr></table></figure></p>
<h5 id="缺少的："><a href="#缺少的：" class="headerlink" title="缺少的："></a>缺少的：</h5><p>有些Java中能用的操作，在表达式函数中不能用：</p>
<ul>
<li>this</li>
<li>super</li>
<li>new</li>
<li>Explicit generic invocatio</li>
</ul>
<h5 id="Null-Coalescing-操作："><a href="#Null-Coalescing-操作：" class="headerlink" title="Null Coalescing 操作："></a>Null Coalescing 操作：</h5><p>如果是null，选左边；不是，选右边<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:text=&quot;@&#123;user.displayName ?? user.lastName&#125;&quot;</div></pre></td></tr></table></figure></p>
<p>等价于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:text=&quot;@&#123;user.displayName != null ? user.displayName : user.lastName&#125;&quot;</div></pre></td></tr></table></figure>
<h5 id="Property-Reference："><a href="#Property-Reference：" class="headerlink" title="Property Reference："></a>Property Reference：</h5><p>使用这样的格式引用类的properties、fields、getters和ObservableFields：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:text=&quot;@&#123;user.lastName&#125;&quot;</div></pre></td></tr></table></figure></p>
<h5 id="避免-NullPointerException"><a href="#避免-NullPointerException" class="headerlink" title="避免 NullPointerException"></a>避免 NullPointerException</h5><p>Data Binding代码生成时会自动检查null，如果存在null，会为对象赋默认值。</p>
<h5 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h5><p>常见的有 arrays, lists, sparse lists, and maps；为了简便，可以使用[]来调用。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"android.util.SparseArray"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"java.util.Map"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"java.util.List"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"list"</span> <span class="attr">type</span>=<span class="string">"List&amp;lt;String&amp;gt;"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"sparse"</span> <span class="attr">type</span>=<span class="string">"SparseArray&amp;lt;String&amp;gt;"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"map"</span> <span class="attr">type</span>=<span class="string">"Map&amp;lt;String, String&amp;gt;"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"index"</span> <span class="attr">type</span>=<span class="string">"int"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"key"</span> <span class="attr">type</span>=<span class="string">"String"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></div><div class="line">…</div><div class="line">android:text="@&#123;list[index]&#125;"</div><div class="line">…</div><div class="line">android:text="@&#123;sparse[index]&#125;"</div><div class="line">…</div><div class="line">android:text="@&#123;map[key]&#125;"</div></pre></td></tr></table></figure>
<h5 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h5><p>这样用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:text=&apos;@&#123;map[&quot;firstName&quot;]&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>或者这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">android:text=&quot;@&#123;map[`firstName`&#125;&quot;</div><div class="line">android:text=&quot;@&#123;map[&apos;firstName&apos;]&#125;&quot;</div></pre></td></tr></table></figure></p>
<h5 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h5><p>简单的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:padding=&quot;@&#123;large? @dimen/largePadding : @dimen/smallPadding&#125;&quot;</div></pre></td></tr></table></figure></p>
<h4 id="6-Data-对象"><a href="#6-Data-对象" class="headerlink" title="6. Data 对象"></a>6. Data 对象</h4><p>任何POJO都可用于Data Binding。修改POJO不会导致UI更新。data binding真正的力量在于，让你的data objects对data changes有notify的能力。有三种数据变化通知机制：</p>
<ul>
<li>observable objects</li>
<li>observable fields</li>
<li>observable collections</li>
</ul>
<p>更多请看：<a href="https://developer.android.com/topic/libraries/data-binding/index.html#listener_bindings" target="_blank" rel="external">https://developer.android.com/topic/libraries/data-binding/index.html#listener_bindings</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/07/EP13-DataBinding-1/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DrunkPiano">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DrunkPiano的Android日常">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DrunkPiano的Android日常" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/07/EP13-DataBinding-1/" itemprop="url">
                  EP13-DataBinding(1)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-07T22:03:48+08:00">
                2016-12-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/07/EP13-DataBinding-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/07/EP13-DataBinding-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="DataBinding"><a href="#DataBinding" class="headerlink" title="DataBinding"></a>DataBinding</h3><p>DataBinding是Android UI团队推出的适合于MVVM开发模式的扩展包。<br>简单介绍一下使用方法，翻译整理自Google的文档 <a href="https://developer.android.com/topic/libraries/data-binding/index.html#layout_details" target="_blank" rel="external">Android Developers</a>：    </p>
<h3 id="1-配置"><a href="#1-配置" class="headerlink" title="1. 配置"></a>1. 配置</h3><p>在Module的build.gradle中加入下面的代码就配置好了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dataBinding &#123;</div><div class="line">    enabled true</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-layout"><a href="#2-layout" class="headerlink" title="2. layout"></a>2. layout</h3><p>这时候XML已经不是单纯展示UI了。现在，我们要了原来的ViewGroup（各种线性、相对布局等等）外面，加入layout布局。和一个新的节点：data。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!--data节点相当于View和Model中间的一座桥梁--&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">data</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"com.example.User"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">data</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">       <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></div><div class="line">       <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">       <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line">       <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line">           <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">           <span class="attr">android:text</span>=<span class="string">"@&#123;user.firstName&#125;"</span>/&gt;</div><div class="line">       <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line">           <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">           <span class="attr">android:text</span>=<span class="string">"@&#123;user.lastName&#125;"</span>/&gt;</div><div class="line">   <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>其一，data节点中的variable描述了可能在layout中使用的属性。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;variable name=&quot;user&quot; type=&quot;com.example.User&quot;/&gt;</div></pre></td></tr></table></figure></p>
<p>其二，用”@{}”函数来描述属性对应的表达式。这里textView的值设置成user的firstName属性：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line">          <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">          <span class="attr">android:text</span>=<span class="string">"@&#123;user.firstName&#125;"</span>/&gt;</div></pre></td></tr></table></figure></p>
<h3 id="3-Model"><a href="#3-Model" class="headerlink" title="3. Model"></a>3. Model</h3><p>假设我们有一个叫作User的<strong>POJO</strong>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">   <span class="keyword">public</span> <span class="keyword">final</span> String firstName;</div><div class="line">   <span class="keyword">public</span> <span class="keyword">final</span> String lastName;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String firstName, String lastName)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.firstName = firstName;</div><div class="line">       <span class="keyword">this</span>.lastName = lastName;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个Object的有着永远不会变的对象。在程序里只被读取一次，之后永远不变的data很常见。也可以使用<strong>Java Beans</strong>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String firstName;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String lastName;</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String firstName, String lastName)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.firstName = firstName;</div><div class="line">       <span class="keyword">this</span>.lastName = lastName;</div><div class="line">   &#125;</div><div class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getFirstName</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">this</span>.firstName;</div><div class="line">   &#125;</div><div class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getLastName</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">this</span>.lastName;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从data binding的角度，这两个类是对等的，@{user.firstName}这个表达式会去前面的POJO面找firstName这个field，或者去Java Bean里面找getFirstName()方法。如果POJO里面存在firstName()，还是会去找firstName()方法。    </p>
<h3 id="4-Binding-Data"><a href="#4-Binding-Data" class="headerlink" title="4. Binding Data"></a>4. Binding Data</h3><p>默认地会根据layout文件生成一个Binding class，把这个layout文件转换成Pascal case，以”Binding”结尾（译注：这个文件要在build目录下去找）。上面的layout文件是main_activity.xml所以生成的类是MainActivityBinding。这个类<strong>包含了所有layout属性(比如user variable)和layout的View之间的bindings</strong>，并且知道如何通过binding表达式分配value。    </p>
<p>最简单的创建binding的方法是在inflating的时候这样做：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">   <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">   <span class="comment">//MainActivityBinding在build目录生成</span></div><div class="line">   MainActivityBinding binding = DataBindingUtil.setContentView(<span class="keyword">this</span>, R.layout.main_activity);</div><div class="line">   User user = <span class="keyword">new</span> User(<span class="string">"Larry"</span>, <span class="string">"Liu"</span>);</div><div class="line">   <span class="comment">//自动生成了一个setUser方法,用来传递variable(例子里是user)</span></div><div class="line">   binding.setUser(user);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好了，这样程序就可以运行了。    </p>
<p>另外，还可以这样获取View：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MainActivityBinding binding = MainActivityBinding.inflate(getLayoutInflater());</div></pre></td></tr></table></figure>
<p>如果要绑定ListView或者RecyclerView的adapter里的item，还可以这样用：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ListItemBinding binding = ListItemBinding.inflate(layoutInflater, viewGroup, <span class="keyword">false</span>);</div><div class="line"><span class="comment">//or</span></div><div class="line">ListItemBinding binding = DataBindingUtil.inflate(layoutInflater, R.layout.list_item, viewGroup, <span class="keyword">false</span>);</div></pre></td></tr></table></figure>
<p>DEC 7</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/06/EP12-MVVM和DataBinding/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DrunkPiano">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DrunkPiano的Android日常">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DrunkPiano的Android日常" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/06/EP12-MVVM和DataBinding/" itemprop="url">
                  EP12-MVVM和DataBinding
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-06T21:15:17+08:00">
                2016-12-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/06/EP12-MVVM和DataBinding/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/06/EP12-MVVM和DataBinding/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="MVVM和DataBinding"><a href="#MVVM和DataBinding" class="headerlink" title="MVVM和DataBinding"></a>MVVM和DataBinding</h3><p>印尼钱包可能采用新的开发模式，所以今天了解一下MVVM和DataBinding。    </p>
<p>目前的Android程序结构，常见下面三种开发模式：    </p>
<h4 id="MVC"><a href="#MVC" class="headerlink" title="MVC:"></a><strong>MVC</strong>:</h4><blockquote>
<p>View：对应于xml布局文件<br>Model：实体模型<br>Controllor：对应于Activity业务逻辑，数据处理和UI处理    </p>
</blockquote>
<p>但是XML的View功能太弱，很多视图都要放在Activigy中完成，Activity还承担一些控制逻辑。所以Activity就成了View+Controller。    </p>
<h4 id="MVP"><a href="#MVP" class="headerlink" title="MVP:"></a><strong>MVP:</strong></h4><blockquote>
<p>View: 对应于Activity和xml，负责View的绘制以及与用户交互<br>Model: 实体模型<br>Presenter: 负责完成View于Model间的交互和业务逻辑    </p>
</blockquote>
<p>这样的话Activity就能成为真正的View而不是View和Control的合体，Activity只做UI相关的事。但是Activity需要实现各种跟UI相关的接口，同时要在Activity中编写大量的事件，然后在事件处理中调用presenter的业务处理方法。    </p>
<h4 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM:"></a><strong>MVVM:</strong></h4><blockquote>
<p>View: 对应于Activity和xml，负责View的绘制以及与用户交互<br>Model: 实体模型<br>ViewModel: 负责完成View于Model间的交互,负责业务逻辑    </p>
</blockquote>
<p>MVVM的目标和思想MVP类似，利用数据绑定(<strong>Data Binding</strong>)、依赖属性(Dependency Property)、命令(Command)、路由事件(Routed Event)等新特性，打造了一个更加灵活高效的架构。<br>MVVM有这样几个优点：    </p>
<ul>
<li>数据驱动（ViewModel只要关注数据和业务逻辑，不需要和UI或者控件打交道）</li>
<li>低耦合度（数据是独立于UI的，ViewModel只负责处理和提供数据，控件变了也无所谓）    </li>
<li>更新UI（可以在工作线程中直接修改View Model的数据，剩下的DataBinding搞定）</li>
<li>可复用性（一个View Model复用到多个View中，同样的一份数据，用不同的UI去做展示）</li>
</ul>
<h4 id="DataBinding"><a href="#DataBinding" class="headerlink" title="DataBinding"></a>DataBinding</h4><p>MVVM是舶来品，从Web前端的Argular而来，Angular有<strong>DataBind</strong>功能。<br>Android之前也有一些库比如RoboGuice、ButterKnife实现了类似DataBind的依赖注入框架实现了类似的功能。<br>今年4月Android UI团队发布了一个DataBinding的库。<br>是不是能应用到印尼钱包中呢。明天我再了解一下。</p>
<p>Reference：<br>[1]<a href="https://realm.io/cn/news/data-binding-android-boyar-mount/" target="_blank" rel="external">https://realm.io/cn/news/data-binding-android-boyar-mount/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/05/EP11-迷路在BroadcastReceiver/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DrunkPiano">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DrunkPiano的Android日常">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DrunkPiano的Android日常" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/05/EP11-迷路在BroadcastReceiver/" itemprop="url">
                  EP11-迷路在BroadcastReceiver
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-05T22:40:16+08:00">
                2016-12-05
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/05/EP11-迷路在BroadcastReceiver/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/05/EP11-迷路在BroadcastReceiver/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天我想了半天，怎么给插件提供BroadcastReceiver呢。我画了一张图，分析到，如果要提供木偶给插件，只需要提供一个onReceive()方法。然后，在插件中写一个activity（继承activityable的木偶），在里面使用register、unregister。sendbroadcast方法就行了。然后，用惯用的手段，写一个抽象类作为木偶，比如叫作PluginImlBroadcast，继承BroadcastReceiver，这样就拥有了BroadcastReceiver中的各种方法；然后写一个代理BroadcastReceiver继承自真正的BroadcastReceiver，在里面把木偶跟代理的生命周期进行绑定。    </p>
<p>然后我问同举这样如何，同举说插件中可以直接用BroadcastReceiver啊，不需要提供。我震惊了。确实是这样啊，直接用就行。感觉自己真蠢啊。    </p>
<p>以前我读DynamicLoadApk作者的博客，他说：   </p>
<blockquote>
<p>apk被宿主程序调起以后，apk中的activity其实就是一个普通的对象，不具有activity的性质，因为系统启动activity是要做很多初始化工作的，而我们在应用层通过反射去启动activity是很难完成系统所做的初始化工作的。    </p>
</blockquote>
<p>我想我是被他误导了，所谓的「系统启动activity是要做很多初始化工作的」到底是什么初始化操作？插件提供Activity跟Serivce最大的原因是他们需要在Maifest中注册。我去看了Activity源码，一个Activity的启动是依赖ActivityThread（包含ApplicationThread + ApplicationThreadNative + IApplicationThread）的，源码的复杂程度很高估计要看很久。所以，插件中不需要对动态注册的BroadcastReceiver进行处理，静态注册才需要。至于要不要支持又是另外一回事了。    </p>
<p>感觉自己有点本末倒置，代码经验太少，现在却吃力地研究源码。我想我应该多写点代码，多做点项目吧。</p>
<p>Reference:<br>[1]<a href="http://blog.csdn.net/singwhatiwanna/article/details/18154335" target="_blank" rel="external">http://blog.csdn.net/singwhatiwanna/article/details/18154335</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/02/EP10-多Service/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DrunkPiano">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DrunkPiano的Android日常">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DrunkPiano的Android日常" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/02/EP10-多Service/" itemprop="url">
                  EP10-多Service
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-02T22:32:33+08:00">
                2016-12-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/02/EP10-多Service/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/02/EP10-多Service/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="0x00-为什么JDRobilePlugin要提供多个PluginService"><a href="#0x00-为什么JDRobilePlugin要提供多个PluginService" class="headerlink" title="0x00 为什么JDRobilePlugin要提供多个PluginService"></a>0x00 为什么JDRobilePlugin要提供多个PluginService</h4><p>昨天有个疑问，不同于PluginActivity，插件框架中是要提供多个不同的PluginService的，为什么？昨天我考虑可能是如果再次new 同一个Service木偶的时候，ClassLoader发现parent已经加载过这个类了，就会返回同一个Service实例。其实不是的。在PluginImpActivity(Activityable的子类)中提供了startActivity和startActivityForResult方法，这两个方法都会调用PluginActivity的startPluginContext()方法,而startPluginContext()会再启动一个PluginActivity的对象：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">intent.setClassName(<span class="keyword">this</span>, <span class="keyword">this</span>.getClass().getCanonicalName());</div></pre></td></tr></table></figure>
<p>Activity是可以存在多个自身的实例的，所以在Plugin.java中可以用startActivity方法。从前我不知道一个插件中是可以有多个木偶Activity的。。因为股神中确实只有一个木偶Activity，维护了一个巨大的UIData，其他页面都是Fragment。    </p>
<p>虽然Service也是继承自Context的，但是一个Service在Manifest中注册之后永远只对应一个对象。它没有Activity那样的栈。如果多个木偶Service对应一个PluginService，那么生命周期就错乱了。</p>
<h4 id="0x01-Serviceable和PluginImpService"><a href="#0x01-Serviceable和PluginImpService" class="headerlink" title="0x01 Serviceable和PluginImpService"></a>0x01 Serviceable和PluginImpService</h4><p>现在插件中Plugin先是继承了PluginImpActivity的，PluginImlActivity继承了Activityable。PluginImpActivity在Activityable基础上丰富了一些方法比如setContentView，startActivity，getFunctionProvider等等。<br>同举说Serviceable可以直接去掉了，用抽象类PluginImpService直接继承Service就行了，这样就直接有了Service中所有的方法，包括生命周期。    </p>
<h4 id="0x02-维护多个Service"><a href="#0x02-维护多个Service" class="headerlink" title="0x02 维护多个Service"></a>0x02 维护多个Service</h4><p>这样实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 通过service木偶换取pluginService代理</div><div class="line"> * <span class="doctag">@param</span> clazz service木偶</div><div class="line"> * <span class="doctag">@return</span> pluginService代理</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Class&lt;? extends Service&gt; getProxyServiceClass(Class&lt;?&gt; clazz) &#123;</div><div class="line">	Class&lt;? extends PluginService&gt; proxyServiceClass = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">//判断clazz与PluginImpService是否相同，或同是另一个类的超类或接口</span></div><div class="line">	<span class="keyword">if</span> (PluginImpService.class.isAssignableFrom(clazz)) &#123;</div><div class="line">        <span class="comment">//获取clazz木偶对应的代理（sAttachServices中维护了一个这样的HashTable）</span></div><div class="line">		proxyServiceClass = sAttachServices.get(clazz);</div><div class="line">        <span class="comment">//如果尚未分配代理，并且还有Idle的Service</span></div><div class="line">		<span class="keyword">if</span> (proxyServiceClass == <span class="keyword">null</span> &amp;&amp; sIdleProxyServices.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">//就取出一个代理Service</span></div><div class="line">			proxyServiceClass = sIdleProxyServices.get(<span class="number">0</span>);</div><div class="line">            <span class="comment">//然后把Idle的代理Service去掉一个</span></div><div class="line">			sIdleProxyServices.remove(<span class="number">0</span>);</div><div class="line">            <span class="comment">//在HashTable中添加这一对木偶和代理的关联</span></div><div class="line">			sAttachServices.put(clazz, proxyServiceClass);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> proxyServiceClass;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>sIdleProxyServices的个数，在PluginMaster中设置：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Application app)</span> </span>&#123;</div><div class="line">		RunningEnvironment.init(app);</div><div class="line">		ArrayList&lt;Class&lt;? extends PluginService&gt;&gt; mProxyServiceClasses = <span class="keyword">new</span> ArrayList&lt;Class&lt;? extends PluginService&gt;&gt;();</div><div class="line">		mProxyServiceClasses.add(ProxyService1.class);</div><div class="line">		mProxyServiceClasses.add(ProxyService2.class);</div><div class="line">		ServiceManager.setProxyServicesClass(mProxyServiceClasses);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>ProxyService1.java…等等代理Service，要在PluginMaster所在的aar(RobilePluginSDK)的Manifest中注册。<br>PluginMaster的lib中包含JDRobilePlugin.jar。App中compile RobilePluginSDK.aar。大概就是这样了。    </p>
<p>-DEC 2ND</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/01/EP9-给插件提供Service（二周目）/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DrunkPiano">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DrunkPiano的Android日常">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DrunkPiano的Android日常" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/01/EP9-给插件提供Service（二周目）/" itemprop="url">
                  EP9-给插件提供Service（二周目）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-01T21:36:43+08:00">
                2016-12-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/01/EP9-给插件提供Service（二周目）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/01/EP9-给插件提供Service（二周目）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="给插件提供Serivce-二周目"><a href="#给插件提供Serivce-二周目" class="headerlink" title="给插件提供Serivce(二周目)"></a>给插件提供Serivce(二周目)</h3><p>昨天讲到怎么模仿PluginActivity给插件提供一个PluginService，是一个大概思路，今天写的时候有些细节记录在这里。    </p>
<h4 id="获取Service的构造器"><a href="#获取Service的构造器" class="headerlink" title="获取Service的构造器"></a>获取Service的构造器</h4><p>首先，要想获得PluginService的构造器，就需要：    </p>
<ol>
<li>加载一个<strong>文件路径+包名+PluginService</strong>的类文件（木偶Service）</li>
<li>要满足1，就要先把外部的dex/apk加载到指定的优化路径(optimizedDirectory)里面。    </li>
</ol>
<p>PluginActivity中具体是这样操作的：    </p>
<ol>
<li>new一个BaseDexClassLoader()，参数是：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">super</span>(apkPath, optimizedDirectory, libraryPath, parent);</div></pre></td></tr></table></figure>
</li>
</ol>
<p>这样一来我们就有了一个指定了optimizedDirectory的classLoader。</p>
<ol>
<li><p>用这个classLoader的loadClass(className)方法加载指定的类。由于这个classLoader<strong>已经绑定了optimizedDirectory</strong>，所以className是<strong>包名+类名</strong>就可以了。  </p>
</li>
<li><p>用2中得到的serviceClass这个获得构造器。</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Constructor&lt;?&gt; serviceConstructor = serviceClass</div><div class="line">                    .getConstructor();</div></pre></td></tr></table></figure>
<p>问题来了，在PluginService需要这样的步骤吗？    </p>
<p>答案是我们需要获得刚才new出来的那个classLoader，然后去直接用它去加载插件中继承Serviceable的那个类。    </p>
<p>怎么获取刚才的classLoader呢？事实上，在刚才构造classLoader的时候，PluginClassLoader用Map保存了classLoader的弱引用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//PluginClassLoader.java</span></div><div class="line">ClassLoader pluginLoader = <span class="keyword">new</span> PluginClassLoader(apkPath,</div><div class="line">			apkOutputDir, libPath, parent);</div><div class="line">	<span class="keyword">if</span> (pluginLoader != <span class="keyword">null</span>) &#123;</div><div class="line">		loader = pluginLoader;</div><div class="line">		pluginLoaders.put(apkPath, <span class="keyword">new</span> WeakReference&lt;ClassLoader&gt;(</div><div class="line">				loader));</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>这样的话目测就可以了，但总觉得还少点什么。  </p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>另外，对于多Service的支持，我们知道Activity是可以启动其他Activity的，也可以启动本身的Activity，并且是standard启动模式，可以覆盖（有个疑问，目前插件中不是仅用到一个Activity实例吗。。）；但是Service不能复用（为什么？是不是因为再次new 同一个Service木偶的时候，ClassLoader发现parent已经加载过这个类了，所以返回了同样的实例？）。明天看看。</p>
<p>-DEC 1ST</p>
<h4 id="Appendix："><a href="#Appendix：" class="headerlink" title="Appendix："></a>Appendix：</h4><p>现在的PluginService.java：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 插件文件路径，文件路径+包名+PluginService.java信息加起来才能构造Plugin的Service实例</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String mPluginPath;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 插件包名</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String mPluginPackage;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 获取PluginActivity初始化的classLoader</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> ClassLoader mClassLoader;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Serviceable实例</div><div class="line">     */</div><div class="line">    <span class="keyword">protected</span> Serviceable mPluginService;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">useClassLoaderToLoadService</span><span class="params">(String mPluginPath, String packageNameAndServicePath)</span> </span>&#123;</div><div class="line">        <span class="comment">//mPluginPath是外部apk路径，optimize之前的路径；这里是用key取map中的值的操作</span></div><div class="line">        mClassLoader = PluginClassLoader.getClassLoader(mPluginPath);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Class&lt;?&gt; serviceClass;</div><div class="line"><span class="comment">//            if (CJConfig.DEF_STR.equals(mDexPath)) &#123;</span></div><div class="line"><span class="comment">//                serviceClass = super.getClassLoader().loadClass(mClass);</span></div><div class="line"><span class="comment">//            &#125; else &#123;</span></div><div class="line"><span class="comment">//                serviceClass = this.getClassLoader().loadClass(mClass);</span></div><div class="line"><span class="comment">//            &#125;</span></div><div class="line">            <span class="comment">//packageNameAndServicePath是包名+木偶类名，用来定位插件中的木偶位置</span></div><div class="line">            serviceClass = mClassLoader.loadClass(packageNameAndServicePath);</div><div class="line">            Constructor&lt;?&gt; serviceConstructor = serviceClass</div><div class="line">                    .getConstructor();</div><div class="line">            mPluginService = (Serviceable) serviceConstructor.newInstance();</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        &#125;</div><div class="line"><span class="comment">//        mPluginService.setProxy(this, mDexPath);</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initPath</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//获取插件路径。mPluginPath这个路径是要拿去loadPlugin的（构造BaseDexClassLoader），所以，mPluginPath是指下载的apk的路径或是assets中内置apk的路径</span></div><div class="line">        mPluginPath = PluginManager.getInstance().getPlugin();</div><div class="line"></div><div class="line">        mPluginPackage = getPluginPackageName(mPluginPath);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getPluginPackageName</span><span class="params">(String pluginPath)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            PackageInfo packageInfo = getPackageManager()</div><div class="line">                    .getPackageArchiveInfo(pluginPath, <span class="number">0</span>);</div><div class="line">            <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> packageInfo.packageName;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        initPath();</div><div class="line">        useClassLoaderToLoadService(mPluginPath, mPluginPackage + <span class="string">".RemoteService"</span>);</div><div class="line">        <span class="keyword">if</span> (mPluginService != <span class="keyword">null</span>) &#123;</div><div class="line">            mPluginService.onCreate();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration newConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPluginService != <span class="keyword">null</span>) &#123;</div><div class="line">            mPluginService.onConfigurationChanged(newConfig);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onConfigurationChanged(newConfig);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLowMemory</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPluginService != <span class="keyword">null</span>) &#123;</div><div class="line">            mPluginService.onLowMemory();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onLowMemory();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="meta">@SuppressLint</span>(<span class="string">"NewApi"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTrimMemory</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPluginService != <span class="keyword">null</span>) &#123;</div><div class="line">            mPluginService.onTrimMemory(level);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onTrimMemory(level);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onUnbind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPluginService != <span class="keyword">null</span>) &#123;</div><div class="line">            mPluginService.onUnbind(intent);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onUnbind(intent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRebind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPluginService != <span class="keyword">null</span>) &#123;</div><div class="line">            mPluginService.onRebind(intent);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onRebind(intent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/30/DrunkPianoDaily-EP8/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DrunkPiano">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DrunkPiano的Android日常">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DrunkPiano的Android日常" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/30/DrunkPianoDaily-EP8/" itemprop="url">
                  DrunkPianoDaily-EP8
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-30T22:50:00+08:00">
                2016-11-30
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/30/DrunkPianoDaily-EP8/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/30/DrunkPianoDaily-EP8/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="给插件提供Service"><a href="#给插件提供Service" class="headerlink" title="给插件提供Service"></a>给插件提供Service</h3><h4 id="0x00-Activityable"><a href="#0x00-Activityable" class="headerlink" title="0x00 Activityable"></a>0x00 Activityable</h4><p>我们回忆一下插件中是怎么使用Activity的。    </p>
<ul>
<li><p>1.PluginActivity继承真正的Activity。    </p>
</li>
<li><p>2.在PluginActivity中，通过下面的构造器，获得了插件中Plugin.Java的实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Constructor&lt;?&gt; pluginMainConstructor = pluginMain.getConstructor();<span class="comment">//获取pluginMain的构造方法（pluginMain就是读取的Plugin）</span></div><div class="line">mActivity = (Activityable) pluginMainConstructor</div><div class="line">		.newInstance();</div></pre></td></tr></table></figure>
</li>
<li><p>3.PluginActivity的onCreate()/onResume()..等等生命周期函数里面，先判断mActivity是不是Plugin(Activityable)的实例，如果是，就调用mActivity对应的生命周期  (<em>**</em>事实上其实这一步判断是否是Activityable的实例的操作是多余的，因为mActivity的定义的时候就是用Activityable定义的*)。   </p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line">		initPluginPath();</div><div class="line">		<span class="keyword">if</span> (mActivity != <span class="keyword">null</span> &amp;&amp; mActivity <span class="keyword">instanceof</span> Activityable) &#123;</div><div class="line">			 mActivity.onStart();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">super</span>.onStart();</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h4 id="0x01-Serviceable"><a href="#0x01-Serviceable" class="headerlink" title="0x01 Serviceable"></a>0x01 Serviceable</h4><p>那么，类似地，对于Service，我们首先也要通过构造器，获得插件中的PluginService.java的实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Constructor&lt;?&gt; serviceConstructor = serviceClass</div><div class="line">            .getConstructor(<span class="keyword">new</span> Class[] &#123;&#125;);</div><div class="line">    instance = serviceConstructor.newInstance(<span class="keyword">new</span> Object[] &#123;&#125;);</div><div class="line">    mPluginService = (Serviceable)serviceConstructor.newInstance();</div></pre></td></tr></table></figure>
<p>然后，我们创建一个Serviceable接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Serviceable</span> </span>&#123;</div><div class="line">    <span class="function">IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration newConfig)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onLowMemory</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onTrimMemory</span><span class="params">(<span class="keyword">int</span> level)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">onUnbind</span><span class="params">(Intent intent)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onRebind</span><span class="params">(Intent intent)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onTaskRemoved</span><span class="params">(Intent rootIntent)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后，创建一个PluginService.java，作为代理Service：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> Serviceable mPluginService;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration newConfig)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPluginService != <span class="keyword">null</span>) &#123;</div><div class="line">            mPluginService.onConfigurationChanged(newConfig);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onConfigurationChanged(newConfig);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLowMemory</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPluginService != <span class="keyword">null</span>) &#123;</div><div class="line">            mPluginService.onLowMemory();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onLowMemory();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="meta">@SuppressLint</span>(<span class="string">"NewApi"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTrimMemory</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPluginService != <span class="keyword">null</span>) &#123;</div><div class="line">            mPluginService.onTrimMemory(level);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onTrimMemory(level);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onUnbind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPluginService != <span class="keyword">null</span>) &#123;</div><div class="line">            mPluginService.onUnbind(intent);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onUnbind(intent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRebind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPluginService != <span class="keyword">null</span>) &#123;</div><div class="line">            mPluginService.onRebind(intent);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onRebind(intent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后，我们在插件的PluginService中继承Serviceable,然后覆写各生命周期即可。    </p>
<p>嗯，思路大概就是这个样子。具体还没有写完，明天可以试一下。</p>
<p>-NOV30</p>
<p>Reference:<br>[1] <a href="https://my.oschina.net/kymjs/blog/331997" target="_blank" rel="external">https://my.oschina.net/kymjs/blog/331997</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/29/DrunkPianoDaily-EP7/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DrunkPiano">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DrunkPiano的Android日常">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DrunkPiano的Android日常" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/29/DrunkPianoDaily-EP7/" itemprop="url">
                  DrunkPianoDaily-EP7
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-29T22:34:44+08:00">
                2016-11-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/29/DrunkPianoDaily-EP7/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/29/DrunkPianoDaily-EP7/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="资源替换"><a href="#资源替换" class="headerlink" title="资源替换"></a>资源替换</h3><p>前两回分析了如何动态加载dex并且执行里面的函数。这时候已经可以动态升级dex/apk了。那么apk的资源怎么动态替换呢。DexClassLoader只能加载dex，无法加载apk中的资源。    </p>
<p>有的解决方案是，所有的XML呈现的布局全部用Java代码实现。这样做是可行的，真的有人在用，但很繁琐，比如分辨率等问题实现起来也会比较复杂。    </p>
<p><a href="https://github.com/singwhatiwanna/dynamic-load-apk" target="_blank" rel="external">dynamic-load-apk</a>方案用的是这样的：<br>首先，Activity继承了Context，Context中有两个抽象方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Return an AssetManager instance for your application's package. */</span></div><div class="line"><span class="comment">/** 为应用程序的包返回一个AssetManager实例。 */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> AssetManager <span class="title">getAssets</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"><span class="comment">/** Return a Resources instance for your application's package. */</span></div><div class="line"><span class="comment">/** 为应用程序包返回一个Resources实例 */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Resources <span class="title">getResources</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure>
<p>context就是通过这两个方法在Activity中获取资源的。这两个方法的实现在ContextImpl中。getResuorces返回的resources是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Resources resources = packageInfo.getResources(mainThread);</div><div class="line"><span class="keyword">if</span> (resources != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (displayId != Display.DEFAULT_DISPLAY</div><div class="line">            || overrideConfiguration != <span class="keyword">null</span></div><div class="line">            || (compatInfo != <span class="keyword">null</span> &amp;&amp; compatInfo.applicationScale</div><div class="line">                    != resources.getCompatibilityInfo().applicationScale)) &#123;</div><div class="line">        <span class="comment">//getTopLevelResources根据资源目录、分隔资源目录..等参数提供顶级资源给application</span></div><div class="line">        resources = mResourcesManager.getTopLevelResources(packageInfo.getResDir(),</div><div class="line">                packageInfo.getSplitResDirs(), packageInfo.getOverlayDirs(),</div><div class="line">                packageInfo.getApplicationInfo().sharedLibraryFiles, displayId,</div><div class="line">                overrideConfiguration, compatInfo);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们也想通过<strong>getResources</strong>获取资源，那么可以模仿它这样来写。    </p>
<ul>
<li><p>1.AssetManager中有addAssetsPath方法，参数可以是一个dircetory或者一个ZIP file。它里面有个native方法可以把资源加载到res中。   </p>
</li>
<li><p>2.嗯，然后用assetManager来反射调用（为什么addAssetPath是隐藏的API?）addAssetPath方法，参数是mDexPath，也就是外部apk的路径。如下。    </p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">addAssetPath.invoke(assetManager, mDexPath);</div></pre></td></tr></table></figure>
<ul>
<li>3.然后用这个assetManager创建一个新的资源：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Resources superRes = <span class="keyword">super</span>.getResources();  </div><div class="line">mResources = <span class="keyword">new</span> Resources(mAssetManager, superRes.getDisplayMetrics(),  </div><div class="line">            superRes.getConfiguration());</div></pre></td></tr></table></figure>
<p>最后，要覆写那两个抽象方法哦，不然的话会一直用父类默认得到的AssetManager和Resources：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> AssetManager <span class="title">getAssets</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">return</span> mAssetManager == <span class="keyword">null</span> ? <span class="keyword">super</span>.getAssets() : mAssetManager;  </div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> Resources <span class="title">getResources</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">return</span> mResources == <span class="keyword">null</span> ? <span class="keyword">super</span>.getResources() : mResources;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>大概就是这样了。    </p>
<p>-NOV29</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/28/DrunkPianoDaily-EP6/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DrunkPiano">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DrunkPiano的Android日常">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DrunkPiano的Android日常" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/28/DrunkPianoDaily-EP6/" itemprop="url">
                  DrunkPianoDaily-EP6
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-28T20:00:40+08:00">
                2016-11-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/28/DrunkPianoDaily-EP6/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/28/DrunkPianoDaily-EP6/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="动态加载dex-Part2"><a href="#动态加载dex-Part2" class="headerlink" title="动态加载dex(Part2)"></a>动态加载dex(Part2)</h3><p>上周五说到了把dex文件加载到DexClassLoader中去；加载完成后怎么调用dex中的源码呢？    </p>
<h4 id="0x00-Robile中的实现"><a href="#0x00-Robile中的实现" class="headerlink" title="0x00 Robile中的实现"></a>0x00 Robile中的实现</h4><p>在Robile框架的PluginActivity.java中是这样实现的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pluginContextClass = mPluginPackage + <span class="string">".Plugin"</span>;</div></pre></td></tr></table></figure></p>
<p>所有的插件都符合这样的规范，package根目录下有个.Plugin.java作为插件入口。<br>具体执行哪一个方法？Plugin.java是继承Activityable的，PluginActivity的onCreate结束之后执行onPluginCreate，onPluginCreate中执行了mActivity.onCreate()：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPluginCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mActivity != <span class="keyword">null</span> &amp;&amp; mActivity <span class="keyword">instanceof</span> Activityable) &#123;</div><div class="line">		mActivity.onCreate(<span class="keyword">this</span>, savedInstanceState);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样就进入了插件的生命周期。问题是，这里的mActivity是怎么映射到Plugin的生命周期的？我们可以看到：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Constructor&lt;?&gt; pluginMainConstructor = pluginMain.getConstructor();<span class="comment">//获取pluginMain的构造方法（pluginMain就是读取的Plugin）</span></div><div class="line">mActivity = (Activityable) pluginMainConstructor</div><div class="line">		.newInstance();</div></pre></td></tr></table></figure></p>
<p><strong>这里初始化了一个Plugin.java这个类的构造器，然后mActivity获得了它的instance。</strong>这就是为什么mActivity的onCreate、onResume等等生命周期对应了Plugin的生命周期。    </p>
<h4 id="0x01-执行具体函数"><a href="#0x01-执行具体函数" class="headerlink" title="0x01 执行具体函数"></a>0x01 执行具体函数</h4><p>如果是「热修复」呢，也就是想要执行dex中某个具体的方法，可以反射到具体的方法然后执行：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">targetClass = dexClassLoader.loadClass(<span class="string">"com.drunkpiano.TestClass"</span>);</div><div class="line"><span class="comment">// 遍历类中所有的方法</span></div><div class="line">Method[] methods = targetClass.getDeclaredMethods();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methods.length; i++) &#123;</div><div class="line">    Log.e(TAG, methods[i].toString());</div><div class="line">&#125;</div><div class="line">Method method = targetClass.getDeclaredMethod(<span class="string">"function"</span>);<span class="comment">// 读取指定的方法</span></div><div class="line">method.setAccessible(<span class="keyword">true</span>);<span class="comment">//把方法设为public以支持外部调用</span></div><div class="line">String string = (String) method.invoke(targetClass.newInstance());<span class="comment">// 调用方法</span></div><div class="line">Toast.makeText(<span class="keyword">this</span>, string, Toast.LENGTH_LONG).show();</div></pre></td></tr></table></figure>
<p>另外，看到有些方案说，还可以在主工程中打包一些接口来实现。这里不深究了。<br>-NOV 28</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="DrunkPiano" />
          <p class="site-author-name" itemprop="name">DrunkPiano</p>
          <p class="site-description motion-element" itemprop="description">let's get started</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">15</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/LarryLawrence" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.instagram.com/drunkpianonj/?hl=en" target="_blank" title="Instagram">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Instagram
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/larry-lawrence" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.weibo.com/1687670367/profile?topnav=1&wvr=6&is_all=1" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DrunkPiano</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"drunkpiano"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  

  

  

  


</body>
</html>
